//Main code for Garmin Code Test
//Created By Nathan May
//Date October 25th 2020

#include "Nathan_May_Garmin_Code_Test.h"

int main () 
{
	//just some test data (fyi 0x64 is repeated 260 times)
	unsigned char data_ptr[] = {0x34, 0x34, 0x7f, 0x4f, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22,
								0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64,
								0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64,
								0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64,
								0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64,
								0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64,
								0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64,
								0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64,
								0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64,
								0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64,
								0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64,
								0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64,
								0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64,
								0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64,
								0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64,
								0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64,
								0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64,
								0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64,
								0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64,
								0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64,
								0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64,
								0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64,
								0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64,
								0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64,
								0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64,
								0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64,
								0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64, 0x64,
								0x03, 0x74, 0x04, 0x04, 0x04, 0x35, 0x35, 0x64, 0x64, 0x64, //data you provided starts here
								0x64, 0x00, 0x00, 0x00, 0x00, 0x00, 0x56, 0x45, 0x56, 0x56, 
								0x56, 0x09, 0x09, 0x09};
	int data_size = 294;
	int new_size = 0;
	
	//compressing the data
	new_size = compress_bytes(data_ptr,data_size);
	
	//printing the data
	for(int i = 1; i <= new_size; i++)
	{
		printf("%X\t",data_ptr[i-1]);
		
		if(i%5 == 0)
		{
			printf("\n");
		}
	}
	
	return 0;
}

int compress_bytes(unsigned char * data_ptr, int data_size)
{
	//checking if the data is even compressible in first place
	if(data_size <= 2)
	{
		return data_size;
	}
	
	//setting things up. pattern_count is one because I am considering 1 byte to be 1 pattern
	int new_size = 0;
	int pattern_count = 1;
	int bytes_checked = 0;
	unsigned char * current_data_ptr = data_ptr;
	unsigned char * compare_ptr = data_ptr + 1;
	unsigned char * write_ptr = data_ptr;
	
	//going throught the data and compressing all the repeated bytes
	while(bytes_checked < data_size)
	{	
		//checking for repetitions between subseqent bytes and that  
		//we are not comparing data out of the buffer.
		if(*current_data_ptr == *compare_ptr && bytes_checked < data_size - 1)
		{
			pattern_count++;
			compare_ptr++;
		}
		//if *current_data_ptr != *compare_ptr we know we are at the end of a 
		//repetition and need to compress the data if there is more then 2 repetitions.
		//(theres no point in trying to compress 1 or 2 bytes into 2 bytes)
		else
		{
			//saving the current byte we are looking at
			unsigned char duplicated_sym = *current_data_ptr;
			
			//if there is more than 2 repetitions the data will be compressed here
			if(pattern_count > 2)
			{
				//if there is more than 127 repetitions then the compression byte will overflow
				//so we will need to make x/127 compression bytes with the pattern_count = 127
				//followed by the repeated byte that is repeated + 1 compression byte that has the remaining 
				//count followed by the repeated byte
				//ie, if we have 0x7f 259 times in a row, it will get compressed to 0xff 0x7f, 0xff 0x7f, 0x85 0x7f
				for(int i = 0; i < pattern_count/127;i++)
				{
					//128 is 0x80 which is what I am using for a flag bit for the decompression algorithm
					*write_ptr = 128 + 127;
					write_ptr++;
					*write_ptr = duplicated_sym;
					write_ptr++;
					new_size += 2;
				}
				//the remainder of the count being compressed
				if(pattern_count%127 != 0)
				{
					*write_ptr = 128 + pattern_count%127;
					write_ptr++;
					*write_ptr = duplicated_sym;
					write_ptr++;
					new_size += 2;
				}
			}
			//if there is 2 or less repetitions then the data is not going to be compressed and 
			//just going to be re-written in its new spot in the modified data buffer
			else
			{
				for(int i = 0; i < pattern_count; i++)
				{
					*write_ptr = duplicated_sym;
					write_ptr++;
				}
				new_size += pattern_count;
			}
			//setting things up for the next repetition count
			pattern_count = 1;
			current_data_ptr = compare_ptr;
			compare_ptr++;
		}
		bytes_checked++;
	}
	
	//just wiping the old data remaining in the buffer with null data 
	//(0x80 = 0 repetitions and will never be data or used when compressing data)
	for(int i = new_size; i < data_size; i++)
	{
		data_ptr[i] = 0x80;
	}
	
	return new_size;
}
















































 

